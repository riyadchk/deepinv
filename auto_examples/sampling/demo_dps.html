<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Implementing DPS &mdash; deepinverse 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
    <link rel="shortcut icon" href="../../_static/logo.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script>window.MathJax = {"tex": {"equationNumbers": {"autoNumber": "AMS", "useLabelIds": true}, "macros": {"forw": ["{A\\left({#1}\\right)}", 1], "noise": ["{N\\left({#1}\\right)}", 1], "inverse": ["{R\\left({#1}\\right)}", 1], "inversef": ["{R\\left({#1},{#2}\\right)}", 2], "reg": ["{g\\left({#1}\\right)}", 1], "regname": "g", "sensor": ["{\\eta\\left({#1}\\right)}", 1], "datafid": ["{f\\left({#1},{#2}\\right)}", 2], "datafidname": "f", "distance": ["{d\\left({#1},{#2}\\right)}", 2], "distancename": "d", "denoiser": ["{\\operatorname{D}_{{#2}}\\left({#1}\\right)}", 2], "denoisername": "\\operatorname{D}", "xset": "\\mathcal{X}", "yset": "\\mathcal{Y}", "group": "\\mathcal{G}", "metric": ["{d\\left({#1},{#2}\\right)}", 2], "loss": ["{\\mathcal\\left({#1}\\right)}", 1]}}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Implementing DiffPIR" href="demo_diffpir.html" />
    <link rel="prev" title="Building your custom sampling algorithm." href="demo_custom_kernel.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/deepinv_logolarge.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.physics.html">Physics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.datasets.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.utils.html">Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.loss.html">Loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.optim.html">Optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.pnp.html">PnP and RED algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.unfolded.html">Unfolded algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.sampling.html">Diffusion algorithms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#basics">Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#plug-and-play">Plug-and-Play</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#sampling">Sampling</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="demo_sampling.html">Uncertainty quantification with PnP-ULA.</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_ddrm.html">Image reconstruction with a diffusion model</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_custom_kernel.html">Building your custom sampling algorithm.</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Implementing DPS</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#diffusion-model-loading">Diffusion model loading</a></li>
<li class="toctree-l4"><a class="reference internal" href="#define-diffusion-schedule">Define diffusion schedule</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-dps-algorithm">The DPS algorithm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#denoising-step">Denoising step</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dps-approximation">DPS approximation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dps-algorithm">DPS Algorithm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-dps-in-your-inverse-problem">Using DPS in your inverse problem</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="demo_diffpir.html">Implementing DiffPIR</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#self-supervised-learning">Self-Supervised Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#unfolded">Unfolded</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.multigpu.html">Using multiple GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.notation.html">Math Notation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.contributing.html">How to Contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">deepinverse</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Examples</a></li>
      <li class="breadcrumb-item active">Implementing DPS</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/auto_examples/sampling/demo_dps.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-sampling-demo-dps-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="implementing-dps">
<span id="sphx-glr-auto-examples-sampling-demo-dps-py"></span><h1>Implementing DPS<a class="headerlink" href="#implementing-dps" title="Link to this heading"></a></h1>
<p>In this tutorial, we will go over the steps in the Diffusion Posterior Sampling (DPS) algorithm introduced in
<a class="reference external" href="https://arxiv.org/abs/2209.14687">Chung et al.</a> The full algorithm is implemented in
<a class="reference internal" href="../../stubs/deepinv.sampling.DPS.html#deepinv.sampling.DPS" title="deepinv.sampling.DPS"><code class="xref py py-meth docutils literal notranslate"><span class="pre">deepinv.sampling.DPS()</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We work with an image of size 64x64 to reduce the computational time of this example.
The algorithm works best with images of size 256x256.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">import</span> <span class="nn">deepinv</span> <span class="k">as</span> <span class="nn">dinv</span>
<span class="kn">from</span> <span class="nn">deepinv.utils.plotting</span> <span class="kn">import</span> <span class="n">plot</span>
<span class="kn">from</span> <span class="nn">deepinv.optim.data_fidelity</span> <span class="kn">import</span> <a href="https://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">L2</span></a>
<span class="kn">from</span> <span class="nn">deepinv.utils.demo</span> <span class="kn">import</span> <span class="n">load_url_image</span><span class="p">,</span> <span class="n">get_image_url</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>  <span class="c1"># to visualize progress</span>

<a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a> <span class="o">=</span> <span class="n">dinv</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_freer_gpu</span><span class="p">()</span> <span class="k">if</span> <a href="https://pytorch.org/docs/2.0/generated/torch.cuda.is_available.html#torch.cuda.is_available" title="torch.cuda.is_available" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span></a><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>

<a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">url</span></a> <span class="o">=</span> <span class="n">get_image_url</span><span class="p">(</span><span class="s2">&quot;butterfly.png&quot;</span><span class="p">)</span>

<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x_true</span></a> <span class="o">=</span> <span class="n">load_url_image</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">url</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">url</span></a><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">)</span>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x_true</span></a><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</pre></div>
</div>
<p>In this tutorial we consider random inpainting as the inverse problem, where the forward operator is implemented
in <a class="reference internal" href="../../stubs/deepinv.physics.Inpainting.html#deepinv.physics.Inpainting" title="deepinv.physics.Inpainting"><code class="xref py py-meth docutils literal notranslate"><span class="pre">deepinv.physics.Inpainting()</span></code></a>. In the example that we use, 90% of the pixels will be masked out randomly,
and we will additionally have Additive White Gaussian Noise (AWGN) of standard deviation  12.75/255.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3.4/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sigma</span></a> <span class="o">=</span> <span class="mf">12.75</span> <span class="o">/</span> <span class="mf">255.0</span>  <span class="c1"># noise level</span>

<span class="n">physics</span> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">dinv</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">Inpainting</span></a><span class="p">(</span>
    <span class="n">tensor_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
    <span class="n">mask</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">pixelwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">,</span>
<span class="p">)</span>

<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">y</span></a> <span class="o">=</span> <span class="n">physics</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x_true</span></a><span class="p">)</span>

<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">imgs</span></a> <span class="o">=</span> <span class="p">[</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">y</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x_true</span></a><span class="p">]</span>
<span class="n">plot</span><span class="p">(</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">imgs</span></a><span class="p">,</span>
    <span class="n">titles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;measurement&quot;</span><span class="p">,</span> <span class="s2">&quot;groundtruth&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_demo_dps_001.png" srcset="../../_images/sphx_glr_demo_dps_001.png" alt="measurement, groundtruth" class = "sphx-glr-single-img"/><section id="diffusion-model-loading">
<h2>Diffusion model loading<a class="headerlink" href="#diffusion-model-loading" title="Link to this heading"></a></h2>
<p>We will take a pre-trained diffusion model that was also used for the DiffPIR algorithm, namely the one trained on
the FFHQ 256x256 dataset. Note that this means that the diffusion model was trained with human face images,
which is very different from the image that we consider in our example. Nevertheless, we will see later on that
<code class="docutils literal notranslate"><span class="pre">DPS</span></code> generalizes sufficiently well even in such case.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">dinv</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">DiffUNet</span></a><span class="p">(</span><span class="n">large_model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Downloading: &quot;https://huggingface.co/deepinv/diffunet/resolve/main/diffusion_ffhq_10m.pt?download=true&quot; to /home/runner/.cache/torch/hub/checkpoints/diffusion_ffhq_10m.pt

  0%|          | 0.00/357M [00:00&lt;?, ?B/s]
  5%|▍         | 17.2M/357M [00:00&lt;00:01, 181MB/s]
 12%|█▏        | 43.9M/357M [00:00&lt;00:01, 239MB/s]
 20%|█▉        | 70.3M/357M [00:00&lt;00:01, 256MB/s]
 27%|██▋       | 96.5M/357M [00:00&lt;00:01, 264MB/s]
 35%|███▌      | 126M/357M [00:00&lt;00:00, 280MB/s]
 43%|████▎     | 155M/357M [00:00&lt;00:00, 289MB/s]
 52%|█████▏    | 185M/357M [00:00&lt;00:00, 296MB/s]
 60%|██████    | 215M/357M [00:00&lt;00:00, 301MB/s]
 69%|██████▊   | 245M/357M [00:00&lt;00:00, 306MB/s]
 77%|███████▋  | 274M/357M [00:01&lt;00:00, 307MB/s]
 85%|████████▌ | 305M/357M [00:01&lt;00:00, 310MB/s]
 94%|█████████▍| 335M/357M [00:01&lt;00:00, 312MB/s]
100%|██████████| 357M/357M [00:01&lt;00:00, 294MB/s]
</pre></div>
</div>
</section>
<section id="define-diffusion-schedule">
<h2>Define diffusion schedule<a class="headerlink" href="#define-diffusion-schedule" title="Link to this heading"></a></h2>
<p>We will use the standard linear diffusion noise schedule. Once <span class="math notranslate nohighlight">\(\beta_t\)</span> is defined to follow a linear schedule
that interpolates between <span class="math notranslate nohighlight">\(\beta_{\rm min}\)</span> and <span class="math notranslate nohighlight">\(\beta_{\rm max}\)</span>,
we have the following additional definitions:
<span class="math notranslate nohighlight">\(\alpha_t := 1 - \beta_t\)</span>, <span class="math notranslate nohighlight">\(\bar\alpha_t := \prod_{j=1}^t \alpha_j\)</span>.
The following equations will also be useful
later on (we always assume that <span class="math notranslate nohighlight">\(\mathbf{\epsilon} \sim \mathcal{N}(\mathbf{0}, \mathbf{I})\)</span> hereafter.)</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\mathbf{x}_t = \sqrt{\beta_t}\mathbf{x}_{t-1} + \sqrt{1 - \beta_t}\mathbf{\epsilon}\\\mathbf{x}_t = \sqrt{\bar\alpha_t}\mathbf{x}_0 + \sqrt{1 - \bar\alpha_t}\mathbf{\epsilon}\end{aligned}\end{align} \]</div>
<p>where we use the reparametrization trick.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_train_timesteps</span></a> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Number of timesteps used during training</span>


<span class="k">def</span> <span class="nf">get_betas</span><span class="p">(</span>
    <span class="n">beta_start</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">beta_end</span><span class="o">=</span><span class="mi">20</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_train_timesteps</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_train_timesteps</span></a>
<span class="p">):</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">betas</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.linspace.html#numpy.linspace" title="numpy.linspace" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">linspace</span></a><span class="p">(</span><span class="n">beta_start</span><span class="p">,</span> <span class="n">beta_end</span><span class="p">,</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_train_timesteps</span></a><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">np</span><span class="o">.</span><span class="n">float32</span></a><span class="p">)</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">betas</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/generated/torch.from_numpy.html#torch.from_numpy" title="torch.from_numpy" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span></a><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">betas</span></a><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">)</span>

    <span class="k">return</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">betas</span></a>


<span class="c1"># Utility function to let us easily retrieve \bar\alpha_t</span>
<span class="k">def</span> <span class="nf">compute_alpha</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a><span class="p">):</span>
    <span class="n">beta</span> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/generated/torch.cat.html#torch.cat" title="torch.cat" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cat</span></a><span class="p">([</span><a href="https://pytorch.org/docs/2.0/generated/torch.zeros.html#torch.zeros" title="torch.zeros" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span></a><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">beta</span><span class="o">.</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">),</span> <span class="n">beta</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span>


<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">betas</span></a> <span class="o">=</span> <span class="n">get_betas</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="the-dps-algorithm">
<h2>The DPS algorithm<a class="headerlink" href="#the-dps-algorithm" title="Link to this heading"></a></h2>
<p>Now that the inverse problem is defined, we can apply the DPS algorithm to solve it. The DPS algorithm is
a diffusion algorithm that alternates between a denoising step, a gradient step and a reverse diffusion sampling step.
The algorithm writes as follows, for <span class="math notranslate nohighlight">\(t\)</span> decreasing from <span class="math notranslate nohighlight">\(T\)</span> to <span class="math notranslate nohighlight">\(1\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{equation*}
\begin{aligned}
\widehat{\mathbf{x}}_{t} &amp;= \denoiser{\mathbf{x}_t}{\sqrt{1-\overline{\alpha}_t}/\sqrt{\overline{\alpha}_t}}
\\
\mathbf{g}_t &amp;= \nabla_{\mathbf{x}_t} \log p( \widehat{\mathbf{x}}_{t}(\mathbf{x}_t) | \mathbf{y} ) \\
\mathbf{\varepsilon}_t &amp;= \mathcal{N}(0, \mathbf{I}) \\
\mathbf{x}_{t-1} &amp;= a_t \,\, \mathbf{x}_t
+ b_t \, \, \widehat{\mathbf{x}}_t
+ \tilde{\sigma}_t \, \, \mathbf{\varepsilon}_t + \mathbf{g}_t,
\end{aligned}
\end{equation*}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\denoiser{\cdot}{\sigma}\)</span> is a denoising network for noise level <span class="math notranslate nohighlight">\(\sigma\)</span>,
<span class="math notranslate nohighlight">\(\eta\)</span> is a hyperparameter, and the constants <span class="math notranslate nohighlight">\(\tilde{\sigma}_t, a_t, b_t\)</span> are defined as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{equation*}
\begin{aligned}
  \tilde{\sigma}_t &amp;= \eta \sqrt{ (1 - \frac{\overline{\alpha}_t}{\overline{\alpha}_{t-1}})
  \frac{1 - \overline{\alpha}_{t-1}}{1 - \overline{\alpha}_t}} \\
  a_t &amp;= \sqrt{1 - \overline{\alpha}_{t-1} - \tilde{\sigma}_t^2}/\sqrt{1-\overline{\alpha}_t} \\
  b_t &amp;= \sqrt{\overline{\alpha}_{t-1}} - \sqrt{1 - \overline{\alpha}_{t-1} - \tilde{\sigma}_t^2}
  \frac{\sqrt{\overline{\alpha}_{t}}}{\sqrt{1 - \overline{\alpha}_{t}}}
\end{aligned}
\end{equation*}\end{split}\]</div>
</section>
<section id="denoising-step">
<h2>Denoising step<a class="headerlink" href="#denoising-step" title="Link to this heading"></a></h2>
<p>The first step of DPS consists of applying a denoiser function to the current image <span class="math notranslate nohighlight">\(\mathbf{x}_t\)</span>,
with standard deviation <span class="math notranslate nohighlight">\(\sigma_t = \sqrt{1 - \overline{\alpha}_t}/\sqrt{\overline{\alpha}_t}\)</span>.</p>
<p>This is equivalent to sampling <span class="math notranslate nohighlight">\(\mathbf{x}_t \sim q(\mathbf{x}_t|\mathbf{x}_0)\)</span>, and then computing the
posterior mean.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/generated/torch.ones.html#torch.ones" title="torch.ones" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">ones</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span>  <span class="c1"># choose some arbitrary timestep</span>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a> <span class="o">=</span> <span class="n">compute_alpha</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">betas</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a><span class="o">.</span><span class="n">long</span><span class="p">())</span>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sigmat</span></a> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">/</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x_true</span></a>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0</span></a> <span class="o">+</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sigmat</span></a> <span class="o">*</span> <a href="https://pytorch.org/docs/2.0/generated/torch.randn_like.html#torch.randn_like" title="torch.randn_like" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span></a><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0</span></a><span class="p">)</span>

<span class="c1"># apply denoiser</span>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_t</span></a> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sigmat</span></a><span class="p">)</span>

<span class="c1"># Visualize</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">imgs</span></a> <span class="o">=</span> <span class="p">[</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_t</span></a><span class="p">]</span>
<span class="n">plot</span><span class="p">(</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">imgs</span></a><span class="p">,</span>
    <span class="n">titles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ground-truth&quot;</span><span class="p">,</span> <span class="s2">&quot;noisy&quot;</span><span class="p">,</span> <span class="s2">&quot;posterior mean&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_demo_dps_002.png" srcset="../../_images/sphx_glr_demo_dps_002.png" alt="ground-truth, noisy, posterior mean" class = "sphx-glr-single-img"/></section>
<section id="dps-approximation">
<h2>DPS approximation<a class="headerlink" href="#dps-approximation" title="Link to this heading"></a></h2>
<p>In order to perform gradient-based <strong>posterior sampling</strong> with diffusion models, we have to be able to compute
<span class="math notranslate nohighlight">\(\nabla_{\mathbf{x}_t} \log p(\mathbf{x}_t|\mathbf{y})\)</span>. Applying Bayes rule, we have</p>
<div class="math notranslate nohighlight">
\[\nabla_{\mathbf{x}_t} \log p(\mathbf{x}_t|\mathbf{y}) = \nabla_{\mathbf{x}_t} \log p(\mathbf{x}_t)
+ \nabla_{\mathbf{x}_t} \log p(\mathbf{y}|\mathbf{x}_t)\]</div>
<p>For the former term, we can simply plug-in our estimated score function as in Tweedie’s formula. As the latter term
is intractable, DPS proposes the following approximation (for details, see Theorem 1 of
<a class="reference external" href="https://arxiv.org/abs/2209.14687">Chung et al.</a></p>
<div class="math notranslate nohighlight">
\[\nabla_{\mathbf{x}_t} \log p(\mathbf{x}_t|\mathbf{y}) \approx \nabla_{\mathbf{x}_t} \log p(\mathbf{x}_t)
+ \nabla_{\mathbf{x}_t} \log p(\mathbf{y}|\widehat{\mathbf{x}}_{t})\]</div>
<p>Remarkably, we can now compute the latter term when we have Gaussian noise, as</p>
<div class="math notranslate nohighlight">
\[\log p(\mathbf{y}|\hat{\mathbf{x}}_{t}) =
-\frac{\|\mathbf{y} - A\widehat{\mathbf{x}}_{t}\|_2^2}{2\sigma_y^2}.\]</div>
<p>Moreover, taking the gradient w.r.t. <span class="math notranslate nohighlight">\(\mathbf{x}_t\)</span> can be performed through automatic differentiation.
Let’s see how this can be done in PyTorch. Note that when we are taking the gradient w.r.t. a tensor,
we first have to enable the gradient computation by <code class="docutils literal notranslate"><span class="pre">tensor.requires_grad_()</span></code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The diffPIR algorithm assumes that the images are in the range [-1, 1], whereas standard denoisers
usually output images in the range [0, 1]. This is why we rescale the images before applying the steps.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x_true</span></a> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span>  <span class="c1"># [0, 1] -&gt; [-1, 1]</span>

<span class="n">data_fidelity</span> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">L2</span></a><span class="p">()</span>

<span class="c1"># xt ~ q(xt|x0)</span>
<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># choose some arbitrary timestep</span>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a> <span class="o">=</span> <span class="p">(</span><a href="https://pytorch.org/docs/2.0/generated/torch.ones.html#torch.ones" title="torch.ones" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">ones</span></a><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">)</span>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a> <span class="o">=</span> <span class="n">compute_alpha</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">betas</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a><span class="o">.</span><span class="n">long</span><span class="p">())</span>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0</span></a> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <a href="https://pytorch.org/docs/2.0/generated/torch.randn_like.html#torch.randn_like" title="torch.randn_like" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span></a><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0</span></a><span class="p">)</span>

<span class="c1"># DPS</span>
<span class="k">with</span> <a href="https://pytorch.org/docs/2.0/generated/torch.enable_grad.html#torch.enable_grad" title="torch.enable_grad" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">enable_grad</span></a><span class="p">():</span>
    <span class="c1"># Turn on gradient</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>

    <span class="c1"># normalize to [0,1], denoise, and rescale to [-1, 1]</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_t</span></a> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">/</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="c1"># Log-likelihood</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ll</span></a> <span class="o">=</span> <span class="n">data_fidelity</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_t</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">y</span></a><span class="p">,</span> <span class="n">physics</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1"># Take gradient w.r.t. xt</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">grad_ll</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/generated/torch.autograd.grad.html#torch.autograd.grad" title="torch.autograd.grad" class="sphx-glr-backref-module-torch-autograd sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span></a><span class="p">(</span><span class="n">outputs</span><span class="o">=</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ll</span></a><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Visualize</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">imgs</span></a> <span class="o">=</span> <span class="p">[</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_t</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">grad_ll</span></a><span class="p">]</span>
<span class="n">plot</span><span class="p">(</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">imgs</span></a><span class="p">,</span>
    <span class="n">titles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;groundtruth&quot;</span><span class="p">,</span> <span class="s2">&quot;noisy&quot;</span><span class="p">,</span> <span class="s2">&quot;posterior mean&quot;</span><span class="p">,</span> <span class="s2">&quot;gradient&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_demo_dps_003.png" srcset="../../_images/sphx_glr_demo_dps_003.png" alt="groundtruth, noisy, posterior mean, gradient" class = "sphx-glr-single-img"/></section>
<section id="dps-algorithm">
<h2>DPS Algorithm<a class="headerlink" href="#dps-algorithm" title="Link to this heading"></a></h2>
<p>As we visited all the key components of DPS, we are now ready to define the algorithm. For every denoising
timestep, the algorithm iterates the following</p>
<ol class="arabic simple">
<li><p>Get <span class="math notranslate nohighlight">\(\hat{\mathbf{x}}\)</span> using the denoiser network.</p></li>
<li><p>Compute <span class="math notranslate nohighlight">\(\nabla_{\mathbf{x}_t} \log p(\mathbf{y}|\hat{\mathbf{x}}_t)\)</span> through backpropagation.</p></li>
<li><p>Perform reverse diffusion sampling with DDPM(IM), corresponding to an update with <span class="math notranslate nohighlight">\(\nabla_{\mathbf{x}_t} \log p(\mathbf{x}_t)\)</span>.</p></li>
<li><p>Take a gradient step with <span class="math notranslate nohighlight">\(\nabla_{\mathbf{x}_t} \log p(\mathbf{y}|\hat{\mathbf{x}}_t)\)</span>.</p></li>
</ol>
<p>There are two caveats here. First, in the original work, DPS used DDPM ancestral sampling. As the <a class="reference external" href="https://arxiv.org/abs/2010.02502)">DDIM sampler</a> is a generalization of DDPM in a sense that it retrieves DDPM when
<span class="math notranslate nohighlight">\(\eta = 1.0\)</span>, here we consider DDIM sampling.
One can freely choose the <span class="math notranslate nohighlight">\(\eta\)</span> parameter here, but since we will consider 1000
neural function evaluations (NFEs),
it is advisable to keep it <span class="math notranslate nohighlight">\(\eta = 1.0\)</span>. Second, when taking the log-likelihood gradient step,
the gradient is weighted so that the actual implementation is a static step size times the <span class="math notranslate nohighlight">\(\ell_2\)</span>
norm of the residual:</p>
<div class="math notranslate nohighlight">
\[\nabla_{\mathbf{x}_t} \log p(\mathbf{y}|\hat{\mathbf{x}}_{t}(\mathbf{x}_t)) \simeq
\rho \nabla_{\mathbf{x}_t} \|\mathbf{y} - \mathbf{A}\hat{\mathbf{x}}_{t}\|_2\]</div>
<p>With these in mind, let us solve the inverse problem with DPS!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We only use 200 steps to reduce the computational time of this example. As suggested by the authors of DPS, the
algorithm works best with <code class="docutils literal notranslate"><span class="pre">num_steps</span> <span class="pre">=</span> <span class="pre">1000</span></code>.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_steps</span></a> <span class="o">=</span> <span class="mi">200</span>

<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">skip</span></a> <span class="o">=</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_train_timesteps</span></a> <span class="o">//</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_steps</span></a>

<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">batch_size</span></a> <span class="o">=</span> <span class="mi">1</span>
<a href="https://docs.python.org/3.4/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">eta</span></a> <span class="o">=</span> <span class="mf">1.0</span>

<a href="https://docs.python.org/3.4/library/stdtypes.html#range" title="builtins.range" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">seq</span></a> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_train_timesteps</span></a><span class="p">,</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">skip</span></a><span class="p">)</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">seq_next</span></a> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#range" title="builtins.range" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">seq</span></a><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">time_pairs</span></a> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#range" title="builtins.range" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">seq</span></a><span class="p">),</span> <span class="nb">reversed</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">seq_next</span></a><span class="p">)))</span>

<span class="c1"># measurement</span>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x_true</span></a> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">y</span></a> <span class="o">=</span> <span class="n">physics</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0</span></a><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">))</span>

<span class="c1"># initial sample from x_T</span>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/generated/torch.randn_like.html#torch.randn_like" title="torch.randn_like" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span></a><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0</span></a><span class="p">)</span>

<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xs</span></a> <span class="o">=</span> <span class="p">[</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a><span class="p">]</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_preds</span></a> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a><span class="p">,</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">j</span></a> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">time_pairs</span></a><span class="p">):</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a> <span class="o">=</span> <span class="p">(</span><a href="https://pytorch.org/docs/2.0/generated/torch.ones.html#torch.ones" title="torch.ones" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">ones</span></a><span class="p">(</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">batch_size</span></a><span class="p">)</span> <span class="o">*</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">i</span></a><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">)</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">next_t</span></a> <span class="o">=</span> <span class="p">(</span><a href="https://pytorch.org/docs/2.0/generated/torch.ones.html#torch.ones" title="torch.ones" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">ones</span></a><span class="p">(</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">batch_size</span></a><span class="p">)</span> <span class="o">*</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">j</span></a><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">)</span>

    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a> <span class="o">=</span> <span class="n">compute_alpha</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">betas</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">t</span></a><span class="o">.</span><span class="n">long</span><span class="p">())</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at_next</span></a> <span class="o">=</span> <span class="n">compute_alpha</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">betas</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">next_t</span></a><span class="o">.</span><span class="n">long</span><span class="p">())</span>

    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a> <span class="o">=</span> <a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xs</span></a><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">)</span>

    <span class="k">with</span> <a href="https://pytorch.org/docs/2.0/generated/torch.enable_grad.html#torch.enable_grad" title="torch.enable_grad" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">enable_grad</span></a><span class="p">():</span>
        <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>

        <span class="c1"># 1. denoising step</span>
        <span class="c1"># we call the denoiser using standard deviation instead of the time step.</span>
        <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">aux_x</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span>
        <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_t</span></a> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">model</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">aux_x</span></a><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">/</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_t</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/generated/torch.clip.html#torch.clip" title="torch.clip" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">clip</span></a><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_t</span></a><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># optional</span>

        <span class="c1"># 2. likelihood gradient approximation</span>
        <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">l2_loss</span></a> <span class="o">=</span> <span class="n">data_fidelity</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_t</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">y</span></a><span class="p">,</span> <span class="n">physics</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">norm_grad</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/generated/torch.autograd.grad.html#torch.autograd.grad" title="torch.autograd.grad" class="sphx-glr-backref-module-torch-autograd sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span></a><span class="p">(</span><span class="n">outputs</span><span class="o">=</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">l2_loss</span></a><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">norm_grad</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">norm_grad</span></a><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sigma_tilde</span></a> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a> <span class="o">/</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at_next</span></a><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at_next</span></a><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="p">))</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <a href="https://docs.python.org/3.4/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">eta</span></a>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">c2</span></a> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at_next</span></a><span class="p">)</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sigma_tilde</span></a><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

    <span class="c1"># 3. noise step</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">epsilon</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/generated/torch.randn_like.html#torch.randn_like" title="torch.randn_like" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span></a><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a><span class="p">)</span>

    <span class="c1"># 4. DDPM(IM) step</span>
    <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt_next</span></a> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at_next</span></a><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">c2</span></a> <span class="o">*</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span> <span class="o">*</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_t</span></a>
        <span class="o">+</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sigma_tilde</span></a> <span class="o">*</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">epsilon</span></a>
        <span class="o">+</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">c2</span></a> <span class="o">*</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt</span></a> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">at</span></a><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="o">-</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">norm_grad</span></a>
    <span class="p">)</span>

    <a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_preds</span></a><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x0_t</span></a><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xs</span></a><span class="o">.</span><span class="n">append</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xt_next</span></a><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>

<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">recon</span></a> <span class="o">=</span> <a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">xs</span></a><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># plot the results</span>
<a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a> <span class="o">=</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">recon</span></a> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">imgs</span></a> <span class="o">=</span> <span class="p">[</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">y</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a><span class="p">,</span> <a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x_true</span></a><span class="p">]</span>
<span class="n">plot</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">imgs</span></a><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;measurement&quot;</span><span class="p">,</span> <span class="s2">&quot;model output&quot;</span><span class="p">,</span> <span class="s2">&quot;groundtruth&quot;</span><span class="p">])</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_demo_dps_004.png" srcset="../../_images/sphx_glr_demo_dps_004.png" alt="measurement, model output, groundtruth" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/200 [00:00&lt;?, ?it/s]
  0%|          | 1/200 [00:00&lt;01:27,  2.27it/s]
  1%|          | 2/200 [00:00&lt;01:26,  2.29it/s]
  2%|▏         | 3/200 [00:01&lt;01:26,  2.29it/s]
  2%|▏         | 4/200 [00:01&lt;01:26,  2.28it/s]
  2%|▎         | 5/200 [00:02&lt;01:25,  2.28it/s]
  3%|▎         | 6/200 [00:02&lt;01:25,  2.27it/s]
  4%|▎         | 7/200 [00:03&lt;01:25,  2.26it/s]
  4%|▍         | 8/200 [00:03&lt;01:24,  2.26it/s]
  4%|▍         | 9/200 [00:03&lt;01:24,  2.25it/s]
  5%|▌         | 10/200 [00:04&lt;01:24,  2.25it/s]
  6%|▌         | 11/200 [00:04&lt;01:24,  2.25it/s]
  6%|▌         | 12/200 [00:05&lt;01:23,  2.25it/s]
  6%|▋         | 13/200 [00:05&lt;01:23,  2.25it/s]
  7%|▋         | 14/200 [00:06&lt;01:22,  2.25it/s]
  8%|▊         | 15/200 [00:06&lt;01:22,  2.25it/s]
  8%|▊         | 16/200 [00:07&lt;01:21,  2.26it/s]
  8%|▊         | 17/200 [00:07&lt;01:21,  2.26it/s]
  9%|▉         | 18/200 [00:07&lt;01:20,  2.26it/s]
 10%|▉         | 19/200 [00:08&lt;01:20,  2.24it/s]
 10%|█         | 20/200 [00:08&lt;01:20,  2.24it/s]
 10%|█         | 21/200 [00:09&lt;01:19,  2.24it/s]
 11%|█         | 22/200 [00:09&lt;01:19,  2.25it/s]
 12%|█▏        | 23/200 [00:10&lt;01:18,  2.26it/s]
 12%|█▏        | 24/200 [00:10&lt;01:18,  2.26it/s]
 12%|█▎        | 25/200 [00:11&lt;01:17,  2.25it/s]
 13%|█▎        | 26/200 [00:11&lt;01:17,  2.26it/s]
 14%|█▎        | 27/200 [00:11&lt;01:16,  2.25it/s]
 14%|█▍        | 28/200 [00:12&lt;01:16,  2.26it/s]
 14%|█▍        | 29/200 [00:12&lt;01:15,  2.26it/s]
 15%|█▌        | 30/200 [00:13&lt;01:15,  2.26it/s]
 16%|█▌        | 31/200 [00:13&lt;01:14,  2.26it/s]
 16%|█▌        | 32/200 [00:14&lt;01:14,  2.27it/s]
 16%|█▋        | 33/200 [00:14&lt;01:13,  2.27it/s]
 17%|█▋        | 34/200 [00:15&lt;01:13,  2.26it/s]
 18%|█▊        | 35/200 [00:15&lt;01:15,  2.19it/s]
 18%|█▊        | 36/200 [00:15&lt;01:14,  2.21it/s]
 18%|█▊        | 37/200 [00:16&lt;01:13,  2.22it/s]
 19%|█▉        | 38/200 [00:16&lt;01:12,  2.23it/s]
 20%|█▉        | 39/200 [00:17&lt;01:11,  2.24it/s]
 20%|██        | 40/200 [00:17&lt;01:10,  2.26it/s]
 20%|██        | 41/200 [00:18&lt;01:10,  2.26it/s]
 21%|██        | 42/200 [00:18&lt;01:09,  2.26it/s]
 22%|██▏       | 43/200 [00:19&lt;01:09,  2.26it/s]
 22%|██▏       | 44/200 [00:19&lt;01:08,  2.27it/s]
 22%|██▎       | 45/200 [00:19&lt;01:08,  2.25it/s]
 23%|██▎       | 46/200 [00:20&lt;01:08,  2.26it/s]
 24%|██▎       | 47/200 [00:20&lt;01:07,  2.27it/s]
 24%|██▍       | 48/200 [00:21&lt;01:07,  2.26it/s]
 24%|██▍       | 49/200 [00:21&lt;01:06,  2.27it/s]
 25%|██▌       | 50/200 [00:22&lt;01:06,  2.27it/s]
 26%|██▌       | 51/200 [00:22&lt;01:05,  2.27it/s]
 26%|██▌       | 52/200 [00:23&lt;01:05,  2.27it/s]
 26%|██▋       | 53/200 [00:23&lt;01:04,  2.27it/s]
 27%|██▋       | 54/200 [00:23&lt;01:04,  2.28it/s]
 28%|██▊       | 55/200 [00:24&lt;01:03,  2.28it/s]
 28%|██▊       | 56/200 [00:24&lt;01:03,  2.28it/s]
 28%|██▊       | 57/200 [00:25&lt;01:02,  2.27it/s]
 29%|██▉       | 58/200 [00:25&lt;01:02,  2.27it/s]
 30%|██▉       | 59/200 [00:26&lt;01:02,  2.27it/s]
 30%|███       | 60/200 [00:26&lt;01:01,  2.27it/s]
 30%|███       | 61/200 [00:27&lt;01:01,  2.28it/s]
 31%|███       | 62/200 [00:27&lt;01:00,  2.28it/s]
 32%|███▏      | 63/200 [00:27&lt;00:59,  2.28it/s]
 32%|███▏      | 64/200 [00:28&lt;00:59,  2.29it/s]
 32%|███▎      | 65/200 [00:28&lt;00:58,  2.29it/s]
 33%|███▎      | 66/200 [00:29&lt;00:58,  2.29it/s]
 34%|███▎      | 67/200 [00:29&lt;00:57,  2.30it/s]
 34%|███▍      | 68/200 [00:30&lt;00:58,  2.26it/s]
 34%|███▍      | 69/200 [00:30&lt;00:58,  2.26it/s]
 35%|███▌      | 70/200 [00:30&lt;00:57,  2.27it/s]
 36%|███▌      | 71/200 [00:31&lt;00:57,  2.24it/s]
 36%|███▌      | 72/200 [00:31&lt;00:56,  2.26it/s]
 36%|███▋      | 73/200 [00:32&lt;00:55,  2.27it/s]
 37%|███▋      | 74/200 [00:32&lt;00:56,  2.24it/s]
 38%|███▊      | 75/200 [00:33&lt;00:55,  2.25it/s]
 38%|███▊      | 76/200 [00:33&lt;00:54,  2.27it/s]
 38%|███▊      | 77/200 [00:34&lt;00:53,  2.28it/s]
 39%|███▉      | 78/200 [00:34&lt;00:53,  2.28it/s]
 40%|███▉      | 79/200 [00:34&lt;00:52,  2.29it/s]
 40%|████      | 80/200 [00:35&lt;00:52,  2.29it/s]
 40%|████      | 81/200 [00:35&lt;00:51,  2.29it/s]
 41%|████      | 82/200 [00:36&lt;00:51,  2.29it/s]
 42%|████▏     | 83/200 [00:36&lt;00:50,  2.29it/s]
 42%|████▏     | 84/200 [00:37&lt;00:50,  2.29it/s]
 42%|████▎     | 85/200 [00:37&lt;00:50,  2.29it/s]
 43%|████▎     | 86/200 [00:37&lt;00:49,  2.29it/s]
 44%|████▎     | 87/200 [00:38&lt;00:49,  2.29it/s]
 44%|████▍     | 88/200 [00:38&lt;00:48,  2.29it/s]
 44%|████▍     | 89/200 [00:39&lt;00:48,  2.29it/s]
 45%|████▌     | 90/200 [00:39&lt;00:47,  2.29it/s]
 46%|████▌     | 91/200 [00:40&lt;00:47,  2.30it/s]
 46%|████▌     | 92/200 [00:40&lt;00:47,  2.28it/s]
 46%|████▋     | 93/200 [00:41&lt;00:46,  2.29it/s]
 47%|████▋     | 94/200 [00:41&lt;00:46,  2.30it/s]
 48%|████▊     | 95/200 [00:41&lt;00:45,  2.29it/s]
 48%|████▊     | 96/200 [00:42&lt;00:45,  2.30it/s]
 48%|████▊     | 97/200 [00:42&lt;00:44,  2.29it/s]
 49%|████▉     | 98/200 [00:43&lt;00:44,  2.29it/s]
 50%|████▉     | 99/200 [00:43&lt;00:44,  2.29it/s]
 50%|█████     | 100/200 [00:44&lt;00:43,  2.29it/s]
 50%|█████     | 101/200 [00:44&lt;00:43,  2.29it/s]
 51%|█████     | 102/200 [00:44&lt;00:42,  2.29it/s]
 52%|█████▏    | 103/200 [00:45&lt;00:42,  2.29it/s]
 52%|█████▏    | 104/200 [00:45&lt;00:41,  2.29it/s]
 52%|█████▎    | 105/200 [00:46&lt;00:41,  2.29it/s]
 53%|█████▎    | 106/200 [00:46&lt;00:41,  2.28it/s]
 54%|█████▎    | 107/200 [00:47&lt;00:40,  2.29it/s]
 54%|█████▍    | 108/200 [00:47&lt;00:40,  2.28it/s]
 55%|█████▍    | 109/200 [00:48&lt;00:39,  2.29it/s]
 55%|█████▌    | 110/200 [00:48&lt;00:39,  2.29it/s]
 56%|█████▌    | 111/200 [00:48&lt;00:38,  2.29it/s]
 56%|█████▌    | 112/200 [00:49&lt;00:38,  2.30it/s]
 56%|█████▋    | 113/200 [00:49&lt;00:37,  2.30it/s]
 57%|█████▋    | 114/200 [00:50&lt;00:37,  2.29it/s]
 57%|█████▊    | 115/200 [00:50&lt;00:37,  2.29it/s]
 58%|█████▊    | 116/200 [00:51&lt;00:36,  2.29it/s]
 58%|█████▊    | 117/200 [00:51&lt;00:36,  2.29it/s]
 59%|█████▉    | 118/200 [00:51&lt;00:35,  2.29it/s]
 60%|█████▉    | 119/200 [00:52&lt;00:35,  2.29it/s]
 60%|██████    | 120/200 [00:52&lt;00:34,  2.30it/s]
 60%|██████    | 121/200 [00:53&lt;00:34,  2.29it/s]
 61%|██████    | 122/200 [00:53&lt;00:33,  2.30it/s]
 62%|██████▏   | 123/200 [00:54&lt;00:33,  2.29it/s]
 62%|██████▏   | 124/200 [00:54&lt;00:33,  2.29it/s]
 62%|██████▎   | 125/200 [00:54&lt;00:32,  2.29it/s]
 63%|██████▎   | 126/200 [00:55&lt;00:32,  2.29it/s]
 64%|██████▎   | 127/200 [00:55&lt;00:31,  2.30it/s]
 64%|██████▍   | 128/200 [00:56&lt;00:31,  2.30it/s]
 64%|██████▍   | 129/200 [00:56&lt;00:30,  2.30it/s]
 65%|██████▌   | 130/200 [00:57&lt;00:30,  2.28it/s]
 66%|██████▌   | 131/200 [00:57&lt;00:30,  2.29it/s]
 66%|██████▌   | 132/200 [00:58&lt;00:29,  2.30it/s]
 66%|██████▋   | 133/200 [00:58&lt;00:29,  2.30it/s]
 67%|██████▋   | 134/200 [00:58&lt;00:28,  2.30it/s]
 68%|██████▊   | 135/200 [00:59&lt;00:28,  2.28it/s]
 68%|██████▊   | 136/200 [00:59&lt;00:27,  2.29it/s]
 68%|██████▊   | 137/200 [01:00&lt;00:27,  2.29it/s]
 69%|██████▉   | 138/200 [01:00&lt;00:27,  2.29it/s]
 70%|██████▉   | 139/200 [01:01&lt;00:26,  2.28it/s]
 70%|███████   | 140/200 [01:01&lt;00:26,  2.28it/s]
 70%|███████   | 141/200 [01:01&lt;00:25,  2.29it/s]
 71%|███████   | 142/200 [01:02&lt;00:25,  2.29it/s]
 72%|███████▏  | 143/200 [01:02&lt;00:24,  2.30it/s]
 72%|███████▏  | 144/200 [01:03&lt;00:24,  2.29it/s]
 72%|███████▎  | 145/200 [01:03&lt;00:23,  2.30it/s]
 73%|███████▎  | 146/200 [01:04&lt;00:23,  2.30it/s]
 74%|███████▎  | 147/200 [01:04&lt;00:23,  2.30it/s]
 74%|███████▍  | 148/200 [01:05&lt;00:22,  2.30it/s]
 74%|███████▍  | 149/200 [01:05&lt;00:22,  2.29it/s]
 75%|███████▌  | 150/200 [01:05&lt;00:21,  2.30it/s]
 76%|███████▌  | 151/200 [01:06&lt;00:21,  2.30it/s]
 76%|███████▌  | 152/200 [01:06&lt;00:20,  2.29it/s]
 76%|███████▋  | 153/200 [01:07&lt;00:20,  2.29it/s]
 77%|███████▋  | 154/200 [01:07&lt;00:20,  2.29it/s]
 78%|███████▊  | 155/200 [01:08&lt;00:19,  2.29it/s]
 78%|███████▊  | 156/200 [01:08&lt;00:19,  2.28it/s]
 78%|███████▊  | 157/200 [01:08&lt;00:18,  2.28it/s]
 79%|███████▉  | 158/200 [01:09&lt;00:18,  2.29it/s]
 80%|███████▉  | 159/200 [01:09&lt;00:18,  2.28it/s]
 80%|████████  | 160/200 [01:10&lt;00:17,  2.27it/s]
 80%|████████  | 161/200 [01:10&lt;00:17,  2.23it/s]
 81%|████████  | 162/200 [01:11&lt;00:16,  2.25it/s]
 82%|████████▏ | 163/200 [01:11&lt;00:16,  2.26it/s]
 82%|████████▏ | 164/200 [01:12&lt;00:15,  2.26it/s]
 82%|████████▎ | 165/200 [01:12&lt;00:15,  2.27it/s]
 83%|████████▎ | 166/200 [01:12&lt;00:14,  2.28it/s]
 84%|████████▎ | 167/200 [01:13&lt;00:14,  2.29it/s]
 84%|████████▍ | 168/200 [01:13&lt;00:13,  2.29it/s]
 84%|████████▍ | 169/200 [01:14&lt;00:13,  2.28it/s]
 85%|████████▌ | 170/200 [01:14&lt;00:13,  2.28it/s]
 86%|████████▌ | 171/200 [01:15&lt;00:12,  2.28it/s]
 86%|████████▌ | 172/200 [01:15&lt;00:12,  2.29it/s]
 86%|████████▋ | 173/200 [01:15&lt;00:11,  2.28it/s]
 87%|████████▋ | 174/200 [01:16&lt;00:11,  2.28it/s]
 88%|████████▊ | 175/200 [01:16&lt;00:10,  2.27it/s]
 88%|████████▊ | 176/200 [01:17&lt;00:10,  2.24it/s]
 88%|████████▊ | 177/200 [01:17&lt;00:10,  2.26it/s]
 89%|████████▉ | 178/200 [01:18&lt;00:09,  2.27it/s]
 90%|████████▉ | 179/200 [01:18&lt;00:09,  2.28it/s]
 90%|█████████ | 180/200 [01:19&lt;00:09,  2.22it/s]
 90%|█████████ | 181/200 [01:19&lt;00:08,  2.24it/s]
 91%|█████████ | 182/200 [01:19&lt;00:07,  2.25it/s]
 92%|█████████▏| 183/200 [01:20&lt;00:07,  2.26it/s]
 92%|█████████▏| 184/200 [01:20&lt;00:07,  2.27it/s]
 92%|█████████▎| 185/200 [01:21&lt;00:06,  2.26it/s]
 93%|█████████▎| 186/200 [01:21&lt;00:06,  2.27it/s]
 94%|█████████▎| 187/200 [01:22&lt;00:05,  2.24it/s]
 94%|█████████▍| 188/200 [01:22&lt;00:05,  2.25it/s]
 94%|█████████▍| 189/200 [01:23&lt;00:04,  2.25it/s]
 95%|█████████▌| 190/200 [01:23&lt;00:04,  2.26it/s]
 96%|█████████▌| 191/200 [01:23&lt;00:03,  2.27it/s]
 96%|█████████▌| 192/200 [01:24&lt;00:03,  2.27it/s]
 96%|█████████▋| 193/200 [01:24&lt;00:03,  2.27it/s]
 97%|█████████▋| 194/200 [01:25&lt;00:02,  2.26it/s]
 98%|█████████▊| 195/200 [01:25&lt;00:02,  2.27it/s]
 98%|█████████▊| 196/200 [01:26&lt;00:01,  2.27it/s]
 98%|█████████▊| 197/200 [01:26&lt;00:01,  2.27it/s]
 99%|█████████▉| 198/200 [01:27&lt;00:00,  2.27it/s]
100%|█████████▉| 199/200 [01:27&lt;00:00,  2.26it/s]
100%|██████████| 200/200 [01:27&lt;00:00,  2.25it/s]
100%|██████████| 200/200 [01:27&lt;00:00,  2.27it/s]
</pre></div>
</div>
</section>
<section id="using-dps-in-your-inverse-problem">
<h2>Using DPS in your inverse problem<a class="headerlink" href="#using-dps-in-your-inverse-problem" title="Link to this heading"></a></h2>
<p>You can readily use this algorithm via the <a class="reference internal" href="../../stubs/deepinv.sampling.DPS.html#deepinv.sampling.DPS" title="deepinv.sampling.DPS"><code class="xref py py-meth docutils literal notranslate"><span class="pre">deepinv.sampling.DPS()</span></code></a> class.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">y</span></a> <span class="o">=</span> <span class="n">physics</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">x</span></a><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">dinv</span><span class="o">.</span><span class="n">sampling</span><span class="o">.</span><span class="n">DPS</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">dinv</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">DiffUNet</span></a><span class="p">(),</span> <span class="n">data_fidelity</span><span class="o">=</span><span class="n">dinv</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><a href="https://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">L2</span></a><span class="p">())</span>
<span class="n">xhat</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><a href="https://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">y</span></a><span class="p">,</span> <span class="n">physics</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (1 minutes 31.330 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-sampling-demo-dps-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/31f92417d030e0d2382c52178325ad67/demo_dps.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">demo_dps.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/faf1222544a1ffa01f52a6b80e689f71/demo_dps.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">demo_dps.py</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="demo_custom_kernel.html" class="btn btn-neutral float-left" title="Building your custom sampling algorithm." accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="demo_diffpir.html" class="btn btn-neutral float-right" title="Implementing DiffPIR" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, DeepInv.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NSEKFKYSGR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NSEKFKYSGR', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>